import logger from"fancy-log";import{JSDOM}from"jsdom";import PluginError from"plugin-error";import through2 from"through2";let pluginName="gulp-html-img-wrapper",gulpHtmlImgWrapper=function(c={}){return through2.obj(function(e,t,r){var o;if(e.isNull())r(null,e);else if(e.isStream())r(new PluginError(pluginName,"Streaming not supported"));else{try{let i=Object.assign({extensions:["jpg","png","jpeg"],logger:!0},c),s=new RegExp(`.(${null==(o=i.extensions)?void 0:o.join("|")})$`,"i");var g=e.contents.toString();let n=new JSDOM(g).window.document,l=0;var u,m=n.querySelectorAll("img");let p=e=>(e.removeAttribute("ghiw-exclude"),e.removeAttribute("ghiw-picture-class"),e.removeAttribute("ghiw-responsive-filenames"),e.removeAttribute("ghiw-responsive-media"),e.removeAttribute("ghiw-responsive-extensions"),e),a=0;m.forEach(t=>{if("picture"!==(null==(r=null==(r=t.parentNode)?void 0:r.nodeName)?void 0:r.toLowerCase()))if(t.hasAttribute("ghiw-exclude"))p(t);else{var r=null==(r=t.src.match(s))?void 0:r[1];if(r&&null!=(e=i.extensions)&&e.includes(r)){a++;let o=n.createElement("picture");var e=t.src.replace("."+r,"");if(t.hasAttribute("ghiw-picture-class")&&(o.classList.add(...t.getAttribute("ghiw-picture-class").split(" ")),t.removeAttribute("ghiw-picture-class")),t.hasAttribute("ghiw-responsive-media")&&t.hasAttribute("ghiw-responsive-filenames")&&t.hasAttribute("ghiw-responsive-extensions")){r=t.getAttribute("ghiw-responsive-extensions").split(";").map(e=>e.trim());let e=t.getAttribute("ghiw-responsive-media").split(";").map(e=>e.trim()),s=t.getAttribute("ghiw-responsive-filenames").split(";").map(e=>e.trim());r.forEach(i=>{e.forEach((e,t)=>{var r=n.createElement("source");r.srcset=s[t]+"."+i,r.media=`(${e})`,r.type="image/"+i,o.append(r)})})}else{r=n.createElement("source");r.srcset=e+".webp",r.type="image/webp",o.append(r)}e=(t=p(t)).cloneNode();o.append(e),t.replaceWith(o),l++}else p(t)}}),e.contents=Buffer.from(n.documentElement.outerHTML),this.push(e),i.logger&&l&&(u=1===l?"image was":"images were",logger(pluginName+":",l+` ${u} wrapped in `+e.relative))}catch(e){this.emit("error",new PluginError(pluginName,e))}r()}})};export{gulpHtmlImgWrapper};